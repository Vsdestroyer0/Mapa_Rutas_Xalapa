---
const baseURL = import.meta.env.PUBLIC_API_URL || "http://localhost:3000";
---

<nav class="bg-blue-600 p-4 text-white" data-backend-url={baseURL}>
  <div class="relative md:flex md:justify-between md:items-center">
    <!-- Título y nombre de usuario -->
    <div class="flex flex-col">
      <h1 class="text-lg font-bold">MiRutaXalapa</h1>
      <span id="user-name" class="mt-1 font-semibold"></span>
    </div>

    <!-- Botón para móviles -->
    <button
      id="menu-btn"
      class="md:hidden focus:outline-none absolute right-4 top-4"
      aria-label="Abrir menú"
    >
      <svg
        class="w-6 h-6"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>

    <!-- Menú principal -->
    <div
      id="menu"
      class="hidden w-full flex-col items-end self-end text-right space-y-2 mt-2 md:mt-0 md:flex md:flex-row md:items-center md:justify-end md:w-auto md:space-x-4 md:space-y-0 md:text-left"
    >
      <a href="/" class="hover:underline">Inicio</a>
      <a
        href="/signup"
        class="bg-white text-blue-600 px-3 py-1 rounded-md font-semibold"
        >Registrarse</a
      >
      <a
        href="/login"
        class="bg-white text-blue-600 px-3 py-1 rounded-md font-semibold"
        >Entrar</a
      >
    </div>
  </div>
</nav>

<script type="module">
  const btn = document.getElementById("menu-btn");
  const menu = document.getElementById("menu");
  const userName = document.getElementById("user-name");

  // Toggle menú en móviles
  btn.addEventListener("click", () => {
    menu.classList.toggle("hidden");
  });

  // Verificar si hay usuario logueado
  const user = JSON.parse(localStorage.getItem("user"));
  const isLoggedIn = user?.username;

  if (isLoggedIn) {
    // Mostrar nombre del usuario
    const capitalized =
      user.username.charAt(0).toUpperCase() + user.username.slice(1);
    userName.textContent = `Hola, ${capitalized}`;

    // Cambiar el contenido del menú para usuario logueado
    menu.innerHTML = `
      <a href="/" class="hover:underline">Inicio</a>
      <button
        id="logout-btn"
        class="bg-white text-blue-600 px-3 py-1 rounded-md font-semibold cursor-pointer hover:bg-gray-100 transition-colors"
      >Cerrar sesión</button>
    `;

    // Agregar funcionalidad al botón de cerrar sesión
    const logoutBtn = document.getElementById("logout-btn");
    logoutBtn.addEventListener("click", async () => {
      try {
        // Usar la URL de el coso de emir
        //mejore el enlace para que sirva en produccion y desarrollo
        const navElement = document.querySelector("nav[data-backend-url]");
        const backendURL = navElement.dataset.backendUrl;
        const response = await fetch(`${backendURL}/api/logout`, {
          method: "POST",
          credentials: "include",
          headers: {
            "Content-Type": "application/json",
          },
        });

        console.log("Status de respuesta:", response.status);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Datos recibidos:", data);

        if (data.success) {
          // Limpiar localStorage
          localStorage.removeItem("user");
          // Redirigir al inicio
          window.location.href = "/";
        } else {
          console.error("Respuesta del servidor:", data);
          alert("Error al cerrar sesión: " + (data.message || "Desconocido"));
        }
      } catch (error) {
        console.error("Error completo:", error);
        console.error("Tipo de error:", error.name);
        console.error("Mensaje:", error.message);

        // Intentar cerrar sesión de todas formas limpiando el localStorage
        localStorage.removeItem("user");
        alert("Sesión cerrada localmente. Redirigiendo...");
        window.location.href = "/";
      }
    });
  }
</script>
